<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Monitoring Dashboard</title>
    <!-- Icon -->
    <link rel="icon" href="../static/uploads/favicon.png" sizes="32x32" type="image/png">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #343a40;
            --card-bg: #fff;
            --card-border: #dee2e6;
        }

        [data-theme="dark"] {
            --bg-color: #343a40;
            --text-color: #f8f9fa;
            --card-bg: #495057;
            --card-border: #6c757d;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 40px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
        }

        .toggle-theme {
            cursor: pointer;
            font-size: 0.9rem;
            border: none;
            background: none;
            color: var(--text-color);
        }

        .chart-container {
            width: 100%;
            max-width: 900px;
            margin: 40px auto;
        }

        /* Hide item events container by default */
        #itemEventsContainer {
            max-width: 900px;
            margin: 20px auto;
            display: none;
        }

        table {
            width: 100%;
        }

        th, td {
            padding: 8px;
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <!-- Chart.js Moment Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
</head>
<body>
<!-- Top Navigation and Dark Mode Toggle -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('index') }}" style="text-decoration: none; color: var(--text-color); font-weight: bold;">
            Back to App
        </a>
    </div>
    <button class="toggle-theme" id="themeToggle">Switch to Dark Mode</button>
</div>

<div class="container">
    <h1 class="text-center mb-4">Application Metrics Dashboard</h1>

    <!-- Metrics Cards -->
    <div class="row mb-3 text-center">
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5>Successful Lookups</h5>
                    <!-- Ensure your backend aggregates lookup_success and search_product_success -->
                    <p class="display-4">{{ metrics.lookup_success_total }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5>Lookup Failures</h5>
                    <p class="display-4">{{ metrics.lookup_failure_total }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5>Barcode Failures</h5>
                    <p class="display-4">{{ metrics.barcode_scan_failure_total }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5>Success Rate</h5>
                    <p class="display-4">{{ metrics.success_rate }}%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Form (for both chart and item events) -->
    <form class="form-inline justify-content-center mb-4">
        <div class="form-group mx-2">
            <label for="startDate" class="mr-2">Start Date:</label>
            <input type="text" class="form-control" id="startDate" placeholder="YYYY-MM-DD">
        </div>
        <div class="form-group mx-2">
            <label for="endDate" class="mr-2">End Date:</label>
            <input type="text" class="form-control" id="endDate" placeholder="YYYY-MM-DD">
        </div>
        <button type="button" class="btn btn-primary mx-2" id="updateChartBtn">Update Chart</button>
        <button type="button" class="btn btn-secondary mx-2" id="showItemEventsBtn">Show Item Events</button>
    </form>

    <!-- Combined Bar Chart -->
    <div class="chart-container">
        <canvas id="combinedBarChart"></canvas>
    </div>

    <!-- Item Events Table -->
    <div id="itemEventsContainer">
        <h4 class="mt-4">Item-Level Events</h4>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Time</th>
                <th>Event Type</th>
                <th>Search/UPC</th>
                <th>Item / Search Results</th>
            </tr>
            </thead>
            <tbody id="itemEventsBody">
            <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- JS Dependencies: jQuery, Popper, Bootstrap, Datepicker -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
<script>
    // Declare myChart globally using var
    var myChart = null;

    // Dark mode toggle functionality
    document.getElementById('themeToggle').addEventListener('click', function () {
        const htmlEl = document.documentElement;
        if (htmlEl.getAttribute('data-theme') === 'light') {
            htmlEl.setAttribute('data-theme', 'dark');
            this.textContent = "Switch to Light Mode";
        } else {
            htmlEl.setAttribute('data-theme', 'light');
            this.textContent = "Switch to Dark Mode";
        }
    });

    // Initialize datepickers
    $('#startDate').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true
    });
    $('#endDate').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true
    });

    // Helper function to fetch aggregated data for an event type from /api/historical.
    function fetchEventData(eventType, startDate, endDate) {
        const params = new URLSearchParams({event_type: eventType, start_date: startDate, end_date: endDate});
        return fetch("{{ url_for('historical_data') }}?" + params.toString())
            .then(resp => {
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                return resp.json();
            });
    }

    // Helper function to extract the hour key from an aggregated object.
    // It will try to use d.hour; if not present, it falls back to d.time.
    function getHourKey(d) {
        return d.hour || d.time;
    }

    // Update chart: aggregate the raw data by hour (if needed) and merge the datasets.
    function updateChart() {
        const startDate = document.getElementById('startDate').value.trim();
        const endDate = document.getElementById('endDate').value.trim();

        Promise.all([
            fetchEventData('lookup_success', startDate, endDate),
            fetchEventData('lookup_failure', startDate, endDate),
            fetchEventData('barcode_scan_failure', startDate, endDate),
            fetchEventData('search_product_success', startDate, endDate),
            fetchEventData('search_product_failure', startDate, endDate)
        ]).then(([lookupSuccessData, lookupFailureData, barcodeData, searchSuccessData, searchFailureData]) => {
            console.log("lookup_success:", lookupSuccessData);
            console.log("lookup_failure:", lookupFailureData);
            console.log("barcode_scan_failure:", barcodeData);
            console.log("search_product_success:", searchSuccessData);
            console.log("search_product_failure:", searchFailureData);

            // Combine lookup_success and search_product_success by their hour key.
            const combinedSuccess = {};
            lookupSuccessData.forEach(d => {
                const key = getHourKey(d);
                combinedSuccess[key] = (combinedSuccess[key] || 0) + d.count;
            });
            searchSuccessData.forEach(d => {
                const key = getHourKey(d);
                combinedSuccess[key] = (combinedSuccess[key] || 0) + d.count;
            });
            const combinedSuccessArray = Object.keys(combinedSuccess).map(key => ({
                hour: key,
                count: combinedSuccess[key]
            }));
            console.log("combinedSuccessArray:", combinedSuccessArray);

            // Gather all hour keys from all datasets.
            const allArrays = [combinedSuccessArray, lookupFailureData, barcodeData, searchFailureData];
            const timeSet = new Set();
            allArrays.forEach(arr => arr.forEach(d => timeSet.add(getHourKey(d))));
            let times = Array.from(timeSet).sort();

            // Fallback: if no data is returned, add a dummy data point.
            if (times.length === 0) {
                const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
                times = [now];
                combinedSuccessArray.push({hour: now, count: 0});
                lookupFailureData.push({hour: now, count: 0});
                barcodeData.push({hour: now, count: 0});
                searchFailureData.push({hour: now, count: 0});
            }

            // Merge data: for each hour, get counts from each aggregated dataset.
            const mergedData = times.map(t => {
                const successCount = combinedSuccessArray.find(d => getHourKey(d) === t)?.count || 0;
                const failCount = lookupFailureData.find(d => getHourKey(d) === t)?.count || 0;
                const barcodeCount = barcodeData.find(d => getHourKey(d) === t)?.count || 0;
                const searchFailureCount = searchFailureData.find(d => getHourKey(d) === t)?.count || 0;
                return {
                    hour: t,
                    success: successCount,
                    fail: failCount,
                    barcode: barcodeCount,
                    searchFailure: searchFailureCount
                };
            });
            console.log("mergedData:", mergedData);

            // Destroy previous chart instance if exists.
            if (myChart) {
                myChart.destroy();
            }

            // Convert the hour string to a Date object.
            // Replace the space with 'T' to form an ISO string.
            const labels = mergedData.map(d => new Date(d.hour.replace(' ', 'T')));
            const successCounts = mergedData.map(d => d.success);
            const failCounts = mergedData.map(d => d.fail);
            const barcodeCounts = mergedData.map(d => d.barcode);
            const searchFailureCounts = mergedData.map(d => d.searchFailure);
            const ctx = document.getElementById('combinedBarChart').getContext('2d');

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Successful Lookups',
                            data: successCounts,
                            backgroundColor: 'rgba(0, 128, 0, 0.7)',
                            borderColor: 'rgba(0, 128, 0, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Lookup Failures',
                            data: failCounts,
                            backgroundColor: 'rgba(255, 0, 0, 0.7)',
                            borderColor: 'rgba(255, 0, 0, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Barcode Failures',
                            data: barcodeCounts,
                            backgroundColor: 'rgba(255, 255, 0, 0.7)',
                            borderColor: 'rgba(255, 255, 0, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Product Search Failures',
                            data: searchFailureCounts,
                            backgroundColor: 'rgba(255, 165, 0, 0.7)',
                            borderColor: 'rgba(255, 165, 0, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MMM D, HH:00'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date & Time (Hourly)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => {
                                    const dt = tooltipItems[0].label;
                                    return moment(dt).format('MMM D, HH:00');
                                },
                                label: (tooltipItem) => `Count: ${tooltipItem.parsed.y}`
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 5
                        }
                    }
                }
            });
        }).catch(err => {
            console.error("Error updating chart:", err);
        });
    }

    // Show item-level events in a table.
    function showItemEvents() {
        const startDate = document.getElementById('startDate').value.trim();
        const endDate = document.getElementById('endDate').value.trim();
        const params = new URLSearchParams({start_date: startDate, end_date: endDate});
        fetch("{{ url_for('item_events') }}?" + params.toString())
            .then(resp => {
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                return resp.json();
            })
            .then(data => {
                const container = document.getElementById('itemEventsContainer');
                container.style.display = 'block';
                const tbody = document.getElementById('itemEventsBody');
                tbody.innerHTML = '';
                data.forEach(evt => {
                    const tr = document.createElement('tr');
                    const tdTime = document.createElement('td');
                    const tdType = document.createElement('td');
                    const tdSKU = document.createElement('td');
                    const tdName = document.createElement('td');
                    tdTime.textContent = evt.time;
                    tdType.textContent = evt.event_type;
                    tdSKU.textContent = evt.sku || '-';
                    tdName.textContent = evt.item_name || '-';
                    tr.appendChild(tdTime);
                    tr.appendChild(tdType);
                    tr.appendChild(tdSKU);
                    tr.appendChild(tdName);
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                console.error("Error fetching item events:", err);
            });
    }

    // Bind buttons to update chart and show item events.
    document.getElementById('updateChartBtn').addEventListener('click', updateChart);
    document.getElementById('showItemEventsBtn').addEventListener('click', showItemEvents);

    // On DOM load, set default date range to last 7 days and load the chart.
    window.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const past = new Date();
        past.setDate(today.getDate() - 7);
        const yyyy = today.getFullYear(),
            mm = String(today.getMonth() + 1).padStart(2, '0'),
            dd = String(today.getDate()).padStart(2, '0');
        const yyyyPast = past.getFullYear(),
            mmPast = String(past.getMonth() + 1).padStart(2, '0'),
            ddPast = String(past.getDate()).padStart(2, '0');
        document.getElementById('startDate').value = `${yyyyPast}-${mmPast}-${ddPast}`;
        document.getElementById('endDate').value = `${yyyy}-${mm}-${dd}`;
        updateChart();
    });
</script>
</body>
</html>
