<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monitoring Dashboard</title>
  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Include Moment.js (if needed for date formatting) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <!-- Include the Moment adapter for Chart.js (optional if using time scale) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    table { border-collapse: collapse; width: 50%; margin: auto; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .nav { text-align: right; margin-bottom: 20px; }
    .nav a { text-decoration: none; color: #333; font-weight: bold; }
    .chart-container { width: 80%; margin: 0 auto 40px; }
  </style>
</head>
<body>
  <div class="nav">
      <a href="{{ url_for('index') }}">Back to App</a>
  </div>
  <h1 style="text-align: center;">Application Metrics Dashboard</h1>

  <!-- Metrics Table -->
  <table>
      <tr>
          <th>Metric</th>
          <th>Count</th>
      </tr>
      <tr>
          <td>Successful Lookups</td>
          <td>{{ metrics.lookup_success_total }}</td>
      </tr>
      <tr>
          <td>Lookup Failures (UPC not found)</td>
          <td>{{ metrics.lookup_failure_total }}</td>
      </tr>
      <tr>
          <td>Barcode Decode Failures</td>
          <td>{{ metrics.barcode_scan_failure_total }}</td>
      </tr>
  </table>

  <!-- Combined Bar Chart Section -->
  <div class="chart-container">
      <canvas id="combinedBarChart"></canvas>
  </div>

  <script>
    // Helper function to merge three datasets by their time labels.
    // It creates a unified sorted list of unique times and, for each dataset,
    // fills missing values with 0.
    function mergeDatasets(successData, lookupFailData, barcodeFailData) {
      const timeSet = new Set();
      // Collect all unique time labels from each dataset.
      successData.forEach(item => timeSet.add(item.hour));
      lookupFailData.forEach(item => timeSet.add(item.hour));
      barcodeFailData.forEach(item => timeSet.add(item.hour));

      // Convert to array and sort the times.
      const times = Array.from(timeSet).sort();

      // Helper to build an array of counts for a given dataset, aligned to the common time array.
      function buildCounts(data) {
        const map = {};
        data.forEach(item => { map[item.hour] = item.count; });
        return times.map(time => map[time] || 0);
      }

      return {
        times: times,
        successCounts: buildCounts(successData),
        lookupFailCounts: buildCounts(lookupFailData),
        barcodeFailCounts: buildCounts(barcodeFailData)
      };
    }

    // Fetch historical data for all three event types in parallel.
    Promise.all([
      fetch("{{ url_for('historical_data') }}?event_type=lookup_success&group_by=hour").then(r => r.json()),
      fetch("{{ url_for('historical_data') }}?event_type=lookup_failure&group_by=hour").then(r => r.json()),
      fetch("{{ url_for('historical_data') }}?event_type=barcode_scan_failure&group_by=hour").then(r => r.json())
    ]).then(([successData, lookupFailData, barcodeFailData]) => {
      console.log("Success data:", successData);
      console.log("Lookup failure data:", lookupFailData);
      console.log("Barcode failure data:", barcodeFailData);

      const merged = mergeDatasets(successData, lookupFailData, barcodeFailData);
      const ctx = document.getElementById('combinedBarChart').getContext('2d');

      // Create a grouped bar chart using category x-axis (each label is a time string)
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: merged.times,
          datasets: [
            {
              label: 'Successful Lookups',
              data: merged.successCounts,
              backgroundColor: 'rgba(0, 128, 0, 0.7)',  // Green
              borderColor: 'rgba(0, 128, 0, 1)',
              borderWidth: 1
            },
            {
              label: 'Lookup Failures',
              data: merged.lookupFailCounts,
              backgroundColor: 'rgba(255, 0, 0, 0.7)',  // Red
              borderColor: 'rgba(255, 0, 0, 1)',
              borderWidth: 1
            },
            {
              label: 'Barcode Decode Failures',
              data: merged.barcodeFailCounts,
              backgroundColor: 'rgba(255, 255, 0, 0.7)',  // Yellow
              borderColor: 'rgba(255, 255, 0, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'category',
              title: {
                display: true,
                text: 'Date & Time'
              },
              stacked: false,  // Group bars side by side.
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Count'
              }
            }
          }
        }
      });
    }).catch(error => {
      console.error("Error fetching combined historical data:", error);
    });
  </script>
</body>
</html>
