<!--

GroceryBarcodeScanner - Barcode Scanning Software
Copyright (c) 2024 Jason Dank

This software is licensed under the End User License Agreement (EULA).
Unauthorized use, distribution, or modification is strictly prohibited.

By using this software, you agree to the terms outlined in the EULA.
For more details, refer to the EULA or contact Jason Dank at jasondank@yahoo.com.

-->

<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6666962150921413" crossorigin="anonymous"></script>
  <meta charset="UTF-8">
  <title>Barcode Scanner</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Icon -->
  <link rel="icon" href="../static/uploads/favicon.png" sizes="32x32" type="image/png">
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- QuaggaJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <!-- Custom CSS -->
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #343a40;
      --accent-color: #FFD700;
      --header-bg: #000;
      --header-text: #FFD700;
      --card-bg: rgba(255, 255, 255, 0.9);
    }
    [data-theme="dark"] {
      --bg-color: #343a40;
      --text-color: rgba(220, 220, 220, 1);
      --accent-color: #B8860B;
      --header-bg: #222;
      --header-text: #B8860B;
      --card-bg: rgba(52, 58, 64, 1);
    }
    html {
      scroll-behavior: smooth;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('../static/uploads/IMG_7383.jpg');
      background-size: cover;
      background-position: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    [data-theme="dark"] body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('../static/uploads/night_wentworth.jpg');
      background-size: cover;
      background-position: center;
      z-index: 0;
      pointer-events: none;
    }
    header {
      background-color: var(--header-bg);
      color: var(--header-text);
      border-bottom: 3px solid var(--accent-color);
      position: relative;
      z-index: 1;
    }
    header .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }
    header nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 20px;
    }
    header nav ul li a {
      color: var(--header-text);
      text-decoration: none;
      font-weight: bold;
      transition: color 0.6s ease, background-color 0.6s ease;
      padding: 5px 10px;
      border-radius: 5px;
    }
    header nav ul li a:hover {
      color: var(--header-bg);
      background-color: var(--accent-color);
    }
    .theme-toggle button {
      background: none;
      border: none;
      color: var(--header-text);
      font-weight: bold;
      cursor: pointer;
      outline: none;
    }
    main {
      flex: 1;
      padding: 20px;
      position: relative;
      z-index: 1;
    }
    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 0;
    }
    .logo-img {
      width: 250px;
      height: auto;
    }
    @media (min-width: 768px) {
      .logo-img { width: 375px; }
    }
    @media (min-width: 1024px) {
      .logo-img { width: 500px; }
    }
    .section-card {
      background-color: var(--card-bg);
      border-top: 5px solid var(--accent-color);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
    }
    [data-theme="dark"] .section-card {
      background-color: rgba(0, 0, 0, 0.5);
      border-top: 5px solid var(--accent-color);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .section-card p {
      font-size: 18px;
      line-height: 1.6;
    }
    .btn-custom {
      background-color: var(--accent-color);
      color: var(--text-color);
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 16px;
      font-family: "Times New Roman", serif;
      transition: background-color 0.3s ease;
    }
    .btn-custom:hover { background-color: #e6c200; }
    .btn-code {
      background-color: #2d2d2d;
      color: #f8f8f2;
      font-family: 'Source Code Pro', monospace;
      font-size: 14px;
      padding: 10px 20px;
      border: 1px solid #444;
      border-radius: 4px;
      text-decoration: none;
      display: inline-block;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-code:hover {
      background-color: #3a3a3a;
      transform: translateY(-2px);
    }
    /* Preview images for debugging */
    #preview, #processedPreview {
      max-width: 200px;
      margin-top: 10px;
      display: none;
      border: 2px solid var(--accent-color);
      border-radius: 5px;
    }
  </style>
  <!-- Optional: Include a code font -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
  <!-- Script to persist dark mode -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const currentTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      const toggleButton = document.getElementById('themeToggle');
      if (toggleButton) {
        toggleButton.textContent = currentTheme === 'dark' ? "Switch to Light Mode" : "Switch to Dark Mode";
      }
    });
  </script>
</head>
<body>
  <!-- Header -->
  <header class="py-3">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="logo">
        <div>Wentworth</div>
        <small>Institute of Technology</small>
      </div>
      <nav>
        <ul class="d-flex">
          <li><a href="#home" class="mr-3">Home</a></li>
          <li><a href="#about" class="mr-3">About</a></li>
          <li><a href="#contact" class="mr-3">Contact</a></li>
          <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        </ul>
      </nav>
      <div class="theme-toggle">
        <button id="themeToggle">Switch to Dark Mode</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main id="home">
    <div class="container">
      <!-- Logo Image -->
      <div class="logo-container">
        <img src="../static/uploads/BAC_Logo_tr.png" alt="Logo" class="logo-img">
      </div>

      <!-- Upload / Scan Section -->
      <section class="section-card">
        <p class="text-center text-muted" style="font-size: 16px;">
          You can either search by Item Name, enter the UPC manually, or scan the barcode using your camera.
          For best results, ensure good lighting and a steady hand.
        </p>
        <div class="row">
          <!-- Manual Entry Column -->
          <div class="col-md-6">
            <form id="barcodeForm" method="post" enctype="multipart/form-data">
              <div class="form-group">
                <label for="barcode-id" class="font-weight-bold">Search Item Name or Enter Barcode ID:</label>
                <input type="text" name="barcode_id" id="barcode-id" class="form-control" placeholder="Search Item Name or Enter UPC here" maxlength="20" required>
              </div>
              <button type="submit" class="btn btn-custom">Submit</button>
            </form>
          </div>
          <!-- Camera Scan Column -->
          <div class="col-md-6 text-center">
            <p class="text-muted">Or scan your barcode with your camera</p>
            <button type="button" class="btn btn-custom" onclick="openNativeCamera()">
              <i class="fas fa-camera"></i> Scan Barcode Using Camera
            </button>
            <!-- Hidden file input for native camera capture -->
            <input type="file" accept="image/*;capture=camera" id="native-camera-input" style="display:none">
            <!-- Preview images for debugging -->
            <img id="preview" alt="Captured Image Preview">
            <img id="processedPreview" alt="Processed Image Preview">
          </div>
        </div>
        <!-- Feedback element for scan errors -->
        <div id="scan-feedback" class="alert alert-warning mt-3" style="display:none;">
          No barcode detected. Please try again or search manually using the UPC code.
        </div>
      </section>

      <!-- Results Section -->
      <section class="section-card">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
          {% for message in messages %}
          <p class="mb-0">{{ message|safe }}</p>
          {% endfor %}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endif %}
        {% endwith %}
      </section>

      <!-- About Section -->
      <section id="about" class="section-card">
        <h2>About Our App</h2>
        <p>
          Our barcode scanner app is an innovative solution developed by the Business Affairs Committee of the
          Wentworth Student Government. Designed specifically for college students, it offers a quick and reliable
          way to navigate Tessie’s market—empowering you to check product prices at a glance.
        </p>
        <p>
          Built with Python, JavaScript, and HTML, the app combines state-of-the-art scanning technology with a
          user-friendly interface to ensure smooth and accurate performance.
        </p>
        <p>
          Interested in how we built it, or want to collaborate on the project? Check out our GitHub!
        </p>
        <div class="text-center mt-3">
          <a href="https://github.com/jdank417/GroceryBarcodeScanner" target="_blank" class="btn-code">
            git clone https://github.com/jdank417/GroceryBarcodeScanner.git
          </a>
        </div>
      </section>

      <!-- Contact Section -->
      <section id="contact" class="section-card">
        <h2>Contact Us</h2>
        <ul class="list-unstyled" style="font-size: 20px; font-family: 'Times New Roman', serif;">
          <li>Jason Dank (PM/Fullstack): <a href="mailto:dankj@wit.edu">dankj@wit.edu</a></li>
          <li>Aliya Vagapova (UI/UX): <a href="mailto:vagapovaa@wit.edu">vagapovaa@wit.edu</a></li>
          <li>WSG: <a href="mailto:wsg@wit.edu">wsg@wit.edu</a></li>
        </ul>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p class="mb-0">&copy; 2025 Wentworth Institute of Technology. All Rights Reserved.</p>
    </div>
  </footer>

  <!-- JS Dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    // Helper: convert a data URL to a Blob.
    function dataURLToBlob(dataURL) {
      var arr = dataURL.split(','),
          mime = arr[0].match(/:(.*?);/)[1],
          bstr = atob(arr[1]),
          n = bstr.length,
          u8arr = new Uint8Array(n);
      while(n--) { u8arr[n] = bstr.charCodeAt(n); }
      return new Blob([u8arr], {type: mime});
    }

    // Error reporting function.
    function reportClientError(errorMessage, details, imageData) {
      console.log("Reporting client error:", errorMessage, details);
      if (imageData) {
        var blob = dataURLToBlob(imageData);
        var formData = new FormData();
        formData.append("barcode_image", blob, "failed_scan.jpg");
        formData.append("error", errorMessage);
        formData.append("details", details);
        fetch('/log_client_error', { method: 'POST', body: formData })
          .then(response => response.json())
          .then(data => console.log('Error reported successfully (with image):', data))
          .catch(err => console.error('Error reporting failed:', err));
      } else {
        let payload = {error: errorMessage, details: details};
        fetch('/log_client_error', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => console.log('Error reported successfully (no image):', data))
        .catch(err => console.error('Error reporting failed:', err));
      }
    }

    // Send the file to the server for ML-based barcode region detection.
    async function processImageServer(file) {
      let formData = new FormData();
      formData.append("barcode_image", file);
      try {
        let response = await fetch("/detect_barcode_region", { method: "POST", body: formData });
        let result = await response.json();
        if (result.cropped_image) {
          return "data:image/jpeg;base64," + result.cropped_image;
        } else {
          console.log("Server ML detection did not return a cropped image.");
          return null;
        }
      } catch (err) {
        console.error("Error during server processing:", err);
        return null;
      }
    }

    // Decode barcode using Quagga.
    function decodeBarcode(dataURL, fallbackDataURL = null) {
      Quagga.decodeSingle({
        src: dataURL,
        numOfWorkers: 4,
        locate: true,
        decoder: {
          readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
        }
      }, function(result) {
        if (result && result.codeResult) {
          var code = result.codeResult.code;
          if (code.length === 13 && code.charAt(0) === '0') { code = code.slice(1); }
          document.getElementById('barcode-id').value = code;
          console.log("Barcode detected:", code);
          document.getElementById('barcodeForm').submit();
        } else if (fallbackDataURL) {
          console.log("Processed image decode failed, trying fallback (original) image.");
          // Try decoding the fallback image.
          Quagga.decodeSingle({
            src: fallbackDataURL,
            numOfWorkers: 4,
            locate: true,
            decoder: {
              readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
            }
          }, function(fallbackResult) {
            if (fallbackResult && fallbackResult.codeResult) {
              var code = fallbackResult.codeResult.code;
              if (code.length === 13 && code.charAt(0) === '0') { code = code.slice(1); }
              document.getElementById('barcode-id').value = code;
              console.log("Barcode detected with fallback:", code);
              document.getElementById('barcodeForm').submit();
            } else {
              console.log("Fallback decode failed. Barcode scan unsuccessful.");
              alert("Barcode scan failed. Please try again or search manually by entering the UPC code.");
              // Show the scan-feedback message.
              var feedbackEl = document.getElementById('scan-feedback');
              feedbackEl.style.display = 'block';
              setTimeout(function() {
                feedbackEl.style.display = 'none';
              }, 3000);
            }
          });
        } else {
          console.log("No barcode detected in the image.");
          alert("Barcode scan failed. Please try again or search manually by entering the UPC code.");
          var feedbackEl = document.getElementById('scan-feedback');
          feedbackEl.style.display = 'block';
          setTimeout(function() {
            feedbackEl.style.display = 'none';
          }, 3000);
          reportClientError("Barcode not detected", "Decoding failed.", dataURL);
        }
      });
    }

    // Open native camera/file picker.
    function openNativeCamera() {
      document.getElementById("native-camera-input").click();
    }

    // Listen for changes on the hidden file input.
    document.getElementById("native-camera-input").addEventListener("change", async function(e) {
      if (e.target.files && e.target.files[0]) {
        var file = e.target.files[0];
        // Show original image preview.
        var previewImg = document.getElementById("preview");
        var reader = new FileReader();
        reader.onload = function(evt) {
          previewImg.src = evt.target.result;
          previewImg.style.display = "block";
        };
        reader.readAsDataURL(file);

        console.log("Image captured, sending to server for ML processing.");
        let processedDataURL = await processImageServer(file);
        if (processedDataURL) {
          var processedPreview = document.getElementById("processedPreview");
          processedPreview.src = processedDataURL;
          processedPreview.style.display = "block";
          console.log("ML processed image received, attempting barcode decode.");
          decodeBarcode(processedDataURL, previewImg.src);
        } else {
          console.log("ML processing failed, falling back to original image decode.");
          var fallbackReader = new FileReader();
          fallbackReader.onload = function(evt) {
            decodeBarcode(evt.target.result);
          };
          fallbackReader.readAsDataURL(file);
        }
      }
    });

    // Dark mode toggle functionality.
    document.getElementById('themeToggle').addEventListener('click', function () {
      const htmlEl = document.documentElement;
      if (htmlEl.getAttribute('data-theme') === 'light') {
        htmlEl.setAttribute('data-theme', 'dark');
        this.textContent = "Switch to Light Mode";
        localStorage.setItem('theme', 'dark');
      } else {
        htmlEl.setAttribute('data-theme', 'light');
        this.textContent = "Switch to Dark Mode";
        localStorage.setItem('theme', 'light');
      }
    });
  </script>
</body>
</html>
